{% load staticfiles %}
{% load json_filters %}
{% load pdb %}
<!doctype html>
<html>
<head>
	<script src="{% static 'vendor/jquery/dist/jquery.js' %}"></script>
	<script src="{% static 'vendor/json-editor/dist/jsoneditor.js' %}"></script>
	<script src="{% static 'vendor/bootstrap/dist/js/bootstrap.js' %}"></script>
	<link href="{% static 'vendor/bootstrap/dist/css/bootstrap.css' %}" rel="stylesheet">
	<link href="{% static 'vendor/bootstrap/dist/css/bootstrap-theme.css' %}" rel="stylesheet">
	<script>
	$(function() {
		var json_schema = {{ json_schema | jsonify | safe }};
		// TODO: need to use JSON.parse to prevent code injections
		var current_step_data = {{ current_json | safe}};
		var editor = new JSONEditor(
			document.getElementById("editor_holder"), 
			{
				schema: json_schema,
				startval: current_step_data,
				
				theme: 'bootstrap3',
				iconlib: 'bootstrap3',
				disable_edit_json: true,
				disable_properties: true,
				disable_collapse: true,
				no_additional_properties: true,
				required_by_default: true
			}
		);
		// TODO: enable validation
		// editor.setValue(current_step_data);
		// var errors = editor.validate();
		// if(errors.length) {
		//   // Not valid
		// }

		editor.on("change",  function() {
			$('input#json').val(JSON.stringify(editor.getValue()));
		});
	});
	</script>
</head>
<body>
	<div class="container">
		<h2>Instance for Process: {{instance.process.name}}</h2>
		<div id="editor_holder" class="row"></div>
		<form method="post">
			{% csrf_token %}
			<input type="hidden" name="json" id="json" />
			<div class="form-group">
				{% for transition in instance.currentstep.possible_transitions %}
					<button type="submit" class="btn" name="{{ transition.name }}">{{ transition.remark }}</button>
				{% endfor %}
				{# TODO: Consider if an automatic self-step could be desireable, to allow saving changes without also having to choose what the next step is #}
				{# Should this get a value? Or is the absence of a value the best identifier? #}
				{# Could also use this to autosave periodically via ajax call? #}
				<button type="submit" class="btn btn-default">Save</button>
			</div>
		</form>
	</div>
</body>
</html>