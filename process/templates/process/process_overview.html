{% extends "include/base.html" %}

{% load pdb %}

{% block content %}
    <h1 class="clearfix">{% block title %}Process Overview{% endblock %}
        {% if user.is_staff %}
            <span class="pull-right">
                <a href="{% url 'admin:process_processdefinition_add' %}" class="btn btn-default">New Process</a>
                <a href="{% url 'admin:process_processdefinition_changelist' %}" class="btn btn-default">Manage Processes</a>
            </span>
        {% endif %}
    </h1>
    <p>See whats up with the processes you participate.</p>
    {# FIXME: only for admin #}
    {% for process in processes %}
        <h2 class="clearfix">{{process.name}}
            <span class="pull-right">
                <a href="{% url 'instance_create' process.id %}" class="btn btn-default">New</a>
                {% if user.is_staff %}
                    <a href="{% url 'admin:process_processdefinition_change' process.id %}" class="btn btn-default">Manage</a>
                    <a href="#" class="btn btn-default">Analyze</a>
                {% endif %}
            </span>
        </h2>
        <ul>
            {% for instance in process.instances.all %}
                <li>
                    {# REFACT: consider linking only to processes I am currently the one to work on #}
                    <a href="{% url 'instance_detail' process.id instance.id %}/">
                        <span class="field state">Current state: {{instance.currentstatus.name}}</span>
                        <span class="field role">Current role: {{instance.currentstatus.role.name}} 
                            {% for role_instance in instance.currentstatus.role.role_instance.all %}
                                {% if forloop.first%}({% endif %}
                                {{role_instance.pycuser.username}}
                                {% if not forloop.last %}, {% else %}){% endif %}
                            {% endfor %}
                        </span>
                        {# TODO: should list role instances with role #}
                        {# FIXME: overview_fields is problematic as it might show data that the current user is _NOT_ supposed to see, it is computed for the currently assigned user --dwt #}
                        {% for field, value in instance.overview_fields %}
                            {% if forloop.first %}
                            <br>
                            Detail:
                            {% endif %}
                            <span class="field {{field.field_definition.name}}">{{field.field_definition.name}}: {{value}}</span>
                        {% endfor %}
                        
                    </a>
                    <span class="pull-right">
                        <a href="{% url 'instance_detail' process.id instance.id %}" class="btn btn-default">Status</a>
                        <a href="{% url 'instance_detail' process.id instance.id %}" class="btn btn-default">Work</a>
                    </span>
                </li>
            {% empty %}
                <p>No instances are available.</p>
            {% endfor %}
        </ul>
    {% empty %}
        <p>No processes are available.</p>
    {% endfor %}
{% endblock content %}
